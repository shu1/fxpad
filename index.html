<!doctype html>
<!-- DJ effects pad for Sony Music Hackathon 2015 by Shuichi Aizawa -->
<html>
<head>
<title>DJ effects pad</title>
<script type="text/javascript">
"use strict";

var canvas, context2d, audioContext, inputMan={};

var soundMan = {
	sources:[],
	filterOn:[],
	loFilters:[],
	hiFilters:[]
};

window.onload = function() {
	console.log("init");

	function loadAudio(name, file) {
		if (window.AudioContext) {
			var audio = document.createElement("audio");
			audio.onloadedmetadata = loadedMetadata;
			audio.id = name;
			audio.src = file;
		} else {
			var request = new XMLHttpRequest();
			request.open("get", file, true);
			request.responseType = "arraybuffer";
			request.onload = function() {
				console.log("loadedBuffer " + name);

				audioContext = audioContext || new webkitAudioContext();
				var source = audioContext.createBufferSource();
				source.id = name;
				source.buffer = audioContext.createBuffer(request.response, false);
				soundMan.sources.push(source);
				loadFilters(source);
			}
			request.send();
		}
	}
	loadAudio("Music", "music.wav");
	loadAudio("Vocals", "vocals.wav");
	loadAudio("BG Vocals", "bgvocals.wav");

	canvas = document.getElementById("canvas");
	context2d = canvas.getContext("2d");

	canvas.addEventListener("touchstart", mouseDown);
	canvas.addEventListener("touchmove", mouseMove);
	window.addEventListener("touchend", mouseUp);
	canvas.addEventListener("mousedown", mouseDown);
	canvas.addEventListener("mousemove", mouseMove);
	window.addEventListener("mouseup", mouseUp);
	window.addEventListener("keydown", keyDown);

	inputMan.x = canvas.width/2;
	inputMan.y = canvas.height/2;

	draw();
}

function loadedMetadata(event) {
	console.log("loadedMetadata " + event.target.id);

	audioContext = audioContext || new AudioContext();
	var source = audioContext.createMediaElementSource(event.target);
	soundMan.sources.push(event.target);
	loadFilters(source);
}

function loadFilters(source) {
	var loFilter = audioContext.createBiquadFilter();
	loFilter.type = "lowpass";
	loFilter.frequency.value = audioContext.sampleRate/2;

	var hiFilter = audioContext.createBiquadFilter();
	hiFilter.type = "highpass";
	hiFilter.frequency.value = 10;

	source.connect(loFilter);
	loFilter.connect(hiFilter);
	hiFilter.connect(audioContext.destination);

	soundMan.loFilters.push(loFilter);
	soundMan.hiFilters.push(hiFilter);
	soundMan.filterOn.push(true);
}

function draw() {
	var canvasWidth = canvas.width, canvasHeight = canvas.height;
	context2d.clearRect(0, 0, canvasWidth, canvasHeight);

	context2d.strokeStyle = "lightgray";
	context2d.moveTo(0, 0);
	context2d.lineTo(canvasWidth, canvasHeight);
	context2d.moveTo(canvasWidth, 0);
	context2d.lineTo(0, canvasHeight);
	context2d.moveTo(0, canvasHeight/2);
	context2d.lineTo(canvasWidth, canvasHeight/2);
	context2d.moveTo(canvasWidth/2, 0);
	context2d.lineTo(canvasWidth/2, canvasHeight);
	context2d.stroke();

	if (soundMan.play) {
		context2d.fillStyle = "darkgray";
		context2d.beginPath();
		context2d.arc(inputMan.x, inputMan.y, 20, 0, Math.PI*2);
		context2d.closePath();
		context2d.stroke();
	}

	requestAnimationFrame(draw);
}

function doFilters(x, y) {
	var nyquist = audioContext.sampleRate / 2;
	var noctaves = Math.log(nyquist / 40) / Math.LN2;
	var res = Math.abs(y - 0.5) * 2;	// map 0.5 to 0

	var lo = 0.99, hi = 0.01;	// not max to prevent audio deterioration

	if (x < 0.5) {	// left half is low pass
		lo = x * 2 * 0.8 + 0.2; // map 0 ~ 0.5 to 0.2 ~ 1
	}
	else if (x > 0.5) {	// right half is high pass
		hi = (x - 0.5) * 2 * 0.8;	// map 0.5 ~ 1 to 0 ~ 0.8
	}

	for (var i = soundMan.filterOn.length-1; i >= 0; --i) {
		if (soundMan.filterOn[i]) {
			soundMan.loFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (lo - 1));
			soundMan.hiFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (hi - 1));

			soundMan.loFilters[i].Q.value = res * 30;	// loFilter.Q.maxValue;
			soundMan.hiFilters[i].Q.value = res * 30;	// hiFilter.Q.maxValue;
		}
	}
}

function play() {
	if (!soundMan.play) {
		for (var i = soundMan.sources.length-1; i >= 0; --i) {
			if (window.AudioContext) {
				soundMan.sources[i].play();
			} else {
				soundMan.sources[i].noteOn(0);
			}
			soundMan.play = true;
		}
	}
}

function mouseDown(event) {
	mouseXY(event);
	inputMan.click = true;
}

function mouseXY(event) {
	if (event.touches) {
		inputMan.x = event.touches[0].pageX;
		inputMan.y = event.touches[0].pageY;
	} else {
		inputMan.x = event.pageX;
		inputMan.y = event.pageY;
	}

	inputMan.x -= canvas.offsetLeft;
	inputMan.y -= canvas.offsetTop;

	doFilters(inputMan.x / canvas.width, inputMan.y / canvas.height);
	event.preventDefault();
}

function mouseMove(event) {
	if (inputMan.click) {
		mouseXY(event);
	}
}

function mouseUp(event) {
	inputMan.click = false;
}

function keyDown(event) {
	var i = event.keyCode-49;
	if (i >= 0 && i <= soundMan.filterOn.length-1) {
		soundMan.filterOn[i] = !soundMan.filterOn[i];
		console.log(soundMan.sources[i].id + (soundMan.filterOn[i] ? " on" : " off"));
	}
}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-7050108-2', 'auto');
ga('send', 'pageview');
</script>
</head>
<body>
	<br/>
	<center style="font-family:sans-serif">
		<canvas id="canvas" width="640" height="320" style="border-style:solid"></canvas>
		<div onclick="play()">Play</div>
	</center>
	<br/>
	<div style="width:480px; margin-left:auto; margin-right:auto">
		<center><b>DJ effects pad</b></center>
		<div>
			Click on pad to start playing track.<br/>
			Click/drag circle to change effects.<br/>
		</div>
		<div style="position:relative; top:5px">
			Low Pass Filter - Drag mouse horizontally in left half of screen.<br/>
			High Pass Filter - Drag mouse horizontally in right half of screen.<br/>
			Resonance - Drag mouse vertically in top or bottom half of screen.<br/>
		</div>
		<div style="position:relative; top:10px">
			Made with Web Audio API.
		</div>
	</div>
	<br/>
</body>
</html>
