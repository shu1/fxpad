<!doctype html>
<!-- DJ effects pad for Sony Music Hackathon 2015 by Shuichi Aizawa -->
<html>
<head>
<title>DJ effects pad</title>
<script type="text/javascript">
"use strict";

var canvas, context2d;

function init() {
	console.log("init");

	canvas = document.getElementById("canvas");
	context2d = canvas.getContext("2d");

	inputMan.x = canvas.width/2;
	inputMan.y = canvas.height/2;

	draw();
}

function draw() {
	var canvasWidth = canvas.width, canvasHeight = canvas.height;
	context2d.clearRect(0, 0, canvasWidth, canvasHeight);

	context2d.strokeStyle = "lightgray";
	context2d.moveTo(0, 0);
	context2d.lineTo(canvasWidth, canvasHeight);
	context2d.moveTo(canvasWidth, 0);
	context2d.lineTo(0, canvasHeight);
	context2d.moveTo(0, canvasHeight/2);
	context2d.lineTo(canvasWidth, canvasHeight/2);
	context2d.moveTo(canvasWidth/2, 0);
	context2d.lineTo(canvasWidth/2, canvasHeight);
	context2d.stroke();

	if (soundMan.play) {
		var x = inputMan.x, y = inputMan.y;

		if (inputMan.mouse) {
			doFilters(x / canvasWidth, y / canvasHeight);
		}

		context2d.fillStyle = "darkgray";
		context2d.beginPath();
		context2d.arc(x, y, 20, 0, Math.PI*2);
		context2d.closePath();
		context2d.stroke();
	}

	requestAnimationFrame(draw);
}

var inputMan = {
	mouse:false,
	x:0,
	y:0
};

function mouseDown(event) {
	if (!soundMan.play) {
		playMusic();
	}

	mouseXY(event);
	inputMan.mouse = true;
}

function mouseXY(event) {
	var x, y;
	if (event.touches) {
		x = event.touches[0].pageX;
		y = event.touches[0].pageY;
	} else {
		x = event.pageX;
		y = event.pageY;
	}

	inputMan.x = x - canvas.offsetLeft;
	inputMan.y = y - canvas.offsetTop;

	event.preventDefault();
}

function mouseMove(event) {
	if (inputMan.mouse) {
		mouseXY(event);
	}
}

function mouseUp(event) {
	inputMan.mouse = false;
}

function keyDown(event) {
	var track = event.keyCode-49;
	if (track >= 0 && track <= soundMan.tracks.length-1) {
		soundMan.tracks[track] = !soundMan.tracks[track];
		console.log(soundMan.names[track] + (soundMan.tracks[track] ? " on" : " off"));
	}
}

var audioContext;
var soundMan = {
	names:[],
	tracks:[],
	audios:[],
	loFilters:[],
	hiFilters:[],
	sampleRate:0,
	play:false
};

function playMusic() {
	for (var i = soundMan.audios.length-1; i >= 0; --i) {
		soundMan.audios[i].play();
	}

	soundMan.play = true;
}

function doFilters(x, y) {
	var nyquist = audioContext.sampleRate / 2;
	var noctaves = Math.log(nyquist / 40) / Math.LN2;
	var res = Math.abs(y - 0.5) * 2;	// map 0.5 to 0

	var lo = 0.99, hi = 0.01;	// not max to prevent audio deterioration

	if (x < 0.5) {	// left half is low pass
		lo = x * 2 * 0.8 + 0.2; // map 0 ~ 0.5 to 0.2 ~ 1
	}
	else if (x > 0.5) {	// right half is high pass
		hi = (x - 0.5) * 2 * 0.8;	// map 0.5 ~ 1 to 0 ~ 0.8
	}

	for (var i = soundMan.tracks.length-1; i >= 0; --i) {
		if (soundMan.tracks[i]) {
			soundMan.loFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (lo - 1));
			soundMan.hiFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (hi - 1));

			soundMan.loFilters[i].Q.value = res * 30;	// loFilter.Q.maxValue;
			soundMan.hiFilters[i].Q.value = res * 30;	// hiFilter.Q.maxValue;
		}
	}
}

function loadedMetadata(event) {
	console.log("loadedMetadata " + event.target.id);

	var AudioContext = window.AudioContext || window.webkitAudioContext;
	audioContext = audioContext || new AudioContext();

	var audio = event.target;
	var source = audioContext.createMediaElementSource(audio);

	var loFilter = audioContext.createBiquadFilter();
	loFilter.type = "lowpass";
	loFilter.Q.value = 0;
	loFilter.frequency.value = audioContext.sampleRate;

	var hiFilter = audioContext.createBiquadFilter();
	hiFilter.type = "highpass";
	hiFilter.Q.value = 0;
	hiFilter.frequency.value = 0;

	source.connect(loFilter);
	loFilter.connect(hiFilter);
	hiFilter.connect(audioContext.destination);

	soundMan.audios.push(audio);
	soundMan.loFilters.push(loFilter);
	soundMan.hiFilters.push(hiFilter);
	soundMan.names.push(event.target.id);
	soundMan.tracks.push(true);
}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-7050108-2', 'auto');
ga('send', 'pageview');
</script>
</head>
<body onload="init()" onmouseup="mouseUp(event)" ontouchend="mouseUp(event)" onkeydown="keyDown(event)">
	<br/>
	<center>
		<audio id="Music" src="music.wav" onloadedmetadata="loadedMetadata(event)"></audio>
		<audio id="Vocals" src="vocals.wav" onloadedmetadata="loadedMetadata(event)"></audio>
		<audio id="Background Vocals" src="bgvocals.wav" onloadedmetadata="loadedMetadata(event)"></audio>
		<canvas id="canvas" width="640" height="320" style="border-style:solid"
			onmousedown="mouseDown(event)" onmousemove="mouseMove(event)"
			ontouchstart="mouseDown(event)" ontouchmove="mouseMove(event)"
			ondragenter="event.stopPropagation(); event.preventDefault();"
			ondragover="event.stopPropagation(); event.preventDefault();"></canvas>
	</center>
	<br/>
	<div style="width:480px; margin-left:auto; margin-right:auto">
		<center><b>DJ effects pad</b></center>
		<div>
			Click on pad to start playing track.<br/>
			Click/drag circle to change effects.<br/>
		</div>
		<div style="position:relative; top:5px">
			Low Pass Filter - Drag mouse horizontally in left half of screen.<br/>
			High Pass Filter - Drag mouse horizontally in right half of screen.<br/>
			Resonance - Drag mouse vertically in top or bottom half of screen.<br/>
		</div>
		<div style="position:relative; top:10px">
			Made with Web Audio API.
		</div>
	</div>
	<br/>
</body>
</html>
