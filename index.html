<!doctype html>
<!-- DJ effects pad for Sony Music Hackathon 2015 by Shuichi Aizawa -->
<html>
<head>
<title>DJ effects pad</title>
<meta name="viewport" content="user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<script type="text/javascript">
"use strict";

var canvas, audioContext;

var vars = {
	textHeight:18,
	length:0,
	time:0,
	xys:[],
	texts:[],
	sources:[],
	filterOn:[],
	loFilters:[],
	hiFilters:[],
	colors:[
		"rgba(255,0,0,0.5)",
		"rgba(0,255,0,0.5)",
		"rgba(0,0,255,0.5)"
	]
};

window.onload = function() {
	loadAudio("Music", "music.wav");
	loadAudio("Vocals", "vocals.wav");
	loadAudio("BG Vocals", "bgvocals.wav");

	canvas = document.getElementById("canvas");

	canvas.addEventListener("touchstart", mouseDown);
	canvas.addEventListener("touchmove", mouseMove);
	window.addEventListener("touchend", mouseUp);
	canvas.addEventListener("mousedown", mouseDown);
	canvas.addEventListener("mousemove", mouseMove);
	window.addEventListener("mouseup", mouseUp);
	window.addEventListener("keydown", keyDown);

	draw(0);

	function loadAudio(name, file) {
		vars.length++;

		if (window.AudioContext) {
			var audio = document.createElement("audio");
			audio.onloadedmetadata = loadedMetadata;
			audio.name = name;
			audio.src = file;
		} else {
			var request = new XMLHttpRequest();
			request.open("get", file, true);
			request.responseType = "arraybuffer";
			request.onload = function() {
				audioContext = audioContext || new webkitAudioContext();
				var source = audioContext.createBufferSource();
				source.buffer = audioContext.createBuffer(request.response, false);
				source.name = name;
				vars.sources.push(source);
				setupFilters(source);
			}
			request.send();
		}
	}
}

function loadedMetadata(event) {
	audioContext = audioContext || new AudioContext();
	var source = audioContext.createMediaElementSource(event.target);
	vars.sources.push(event.target);
	setupFilters(source);
}

function setupFilters(source) {
	var loFilter = audioContext.createBiquadFilter();
	loFilter.type = "lowpass";
	loFilter.frequency.value = audioContext.sampleRate/2;
	vars.loFilters.push(loFilter);

	var hiFilter = audioContext.createBiquadFilter();
	hiFilter.type = "highpass";
	hiFilter.frequency.value = 10;
	vars.hiFilters.push(hiFilter);

	source.connect(loFilter);
	loFilter.connect(hiFilter);
	hiFilter.connect(audioContext.destination);

	vars.filterOn.push(true);
	vars.xys.push({x:0.5, y:0.5});
	setTexts();
	draw(0);
}

function setTexts() {
	var context2d = canvas.getContext("2d");
	var cellWidth = canvas.width / vars.sources.length;

	for (var i = vars.sources.length-1; i >= 0; --i) {
		var font = context2d.font = (vars.filterOn[i] ? "bold " : "") + vars.textHeight + "pt sans-serif";
		var width = context2d.measureText(vars.sources[i].name).width;
		var x = (cellWidth - width)/2 + cellWidth*i;
		vars.texts[i] = {font:font, x:x, x2:x+width};
	}
}

function draw(time) {
	if (!time || time > vars.time) {
		var canvasWidth = canvas.width, canvasHeight = canvas.height, context2d = canvas.getContext("2d");
		context2d.clearRect(0, 0, canvasWidth, canvasHeight);

		context2d.strokeStyle = "lightgray";
		context2d.moveTo(0, 0);
		context2d.lineTo(canvasWidth, canvasHeight);
		context2d.moveTo(canvasWidth, 0);
		context2d.lineTo(0, canvasHeight);
		context2d.moveTo(0, canvasHeight/2);
		context2d.lineTo(canvasWidth, canvasHeight/2);
		context2d.moveTo(canvasWidth/2, 0);
		context2d.lineTo(canvasWidth/2, canvasHeight);
		context2d.stroke();

		if (vars.play) {
			for (var i = vars.length-1; i >= 0; --i) {
				context2d.strokeStyle = vars.colors[i];
				context2d.beginPath();
				context2d.arc(vars.xys[i].x * canvasWidth, vars.xys[i].y * canvasHeight, 20, 0, Math.PI*2);
				context2d.stroke();
			}
		}

		var y = canvasHeight-2;
		for (var i = vars.sources.length-1; i >= 0; --i) {
			context2d.fillStyle = vars.colors[i];
			context2d.font = vars.texts[i].font;
			context2d.fillText(vars.sources[i].name, vars.texts[i].x, y);
		}
	}
	vars.time = time;
}

function doFilters(x, y) {
	var nyquist = audioContext.sampleRate / 2;
	var noctaves = Math.log(nyquist / 40) / Math.LN2;
	var res = Math.abs(y - 0.5) * 2;	// map 0.5 to 0

	var lo = 0.99, hi = 0.01;	// not max to prevent audio deterioration

	if (x < 0.5) {	// left half is low pass
		lo = x * 2 * 0.8 + 0.2; // map 0 ~ 0.5 to 0.2 ~ 1
	}
	else if (x > 0.5) {	// right half is high pass
		hi = (x - 0.5) * 2 * 0.8;	// map 0.5 ~ 1 to 0 ~ 0.8
	}

	for (var i = vars.length-1; i >= 0; --i) {
		if (vars.filterOn[i]) {
			vars.loFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (lo - 1));
			vars.hiFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (hi - 1));

			vars.loFilters[i].Q.value = res * 30;
			vars.hiFilters[i].Q.value = res * 30;

			vars.xys[i] = {x:x,y:y};
		}
	}
}

function play() {
	if (!vars.play && vars.sources.length == vars.length) {
		for (var i = vars.length-1; i >= 0; --i) {
			if (window.AudioContext) {
				vars.sources[i].play();
			} else {
				vars.sources[i].noteOn(0);
			}
			vars.play = true;
		}
		if (vars.play) draw(0);
	}
}

function mouseDown(event) {
	mouseXY(event);

	if (vars.y > canvas.height - vars.textHeight) {
		for (var i = vars.length-1; i >= 0; --i) {
			if (vars.x > vars.texts[i].x && vars.x < vars.texts[i].x2) {
				vars.filterOn[i] = !vars.filterOn[i];
				setTexts();
				vars.drag = true;
			}
		}
	}

	if (!vars.drag) {
		doFilters(vars.x / canvas.width, vars.y / canvas.height);
	}

	vars.click = true;
}

function mouseXY(event) {
	if (event.touches) {
		vars.x = event.touches[0].pageX;
		vars.y = event.touches[0].pageY;
	} else {
		vars.x = event.pageX;
		vars.y = event.pageY;
	}
	vars.x -= canvas.offsetLeft;
	vars.y -= canvas.offsetTop;

	requestAnimationFrame(draw);
	event.preventDefault();
}

function mouseMove(event) {
	if (vars.click && !vars.drag) {
		mouseXY(event);
		doFilters(vars.x / canvas.width, vars.y / canvas.height);
	}
}

function mouseUp(event) {
	vars.click = false;
	vars.drag = false;
}

function keyDown(event) {
	var i = event.keyCode-49;
	if (i >= 0 && i <= vars.filterOn.length-1) {
		vars.filterOn[i] = !vars.filterOn[i];
		setTexts();
		draw(0);
	}
}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-7050108-2', 'auto');
ga('send', 'pageview');
</script>
</head>
<body>
	<br/>
	<center>
		<canvas id="canvas" width="800" height="400" style="border-style:solid"></canvas>
		<br/><input type="button" value="   Play   " onclick="play()"/>
	</center>
	<br/>
	<div style="width:480px; margin-left:auto; margin-right:auto">
		<center><b>DJ effects pad</b></center>
		<div>
			Click on pad to start playing track.<br/>
			Click/drag circle to change effects.<br/>
		</div>
		<div style="position:relative; top:5px">
			Low Pass Filter - Drag mouse horizontally in left half of screen.<br/>
			High Pass Filter - Drag mouse horizontally in right half of screen.<br/>
			Resonance - Drag mouse vertically in top or bottom half of screen.<br/>
		</div>
		<div style="position:relative; top:10px">
			Made with Web Audio API.
		</div>
	</div>
	<br/>
</body>
</html>
