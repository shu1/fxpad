<!doctype html>
<!-- DJ effects pad for Google HTML5 Hackathon 2011 by Shuichi Aizawa -->
<html>
<head>
<title>DJ effects pad</title>
<script src="http://connect.soundcloud.com/sdk.js"></script>
<script type="text/javascript">

SC.initialize({
	client_id: '28c66c838c6f68e374e707978b672fa8'
});

var canvas, context2d;

function init() {
console.log("init");
	canvas = document.getElementById("canvas");
	context2d = canvas.getContext("2d");
	
	inputMan.x = canvas.width/2;
	inputMan.y = canvas.height/2;
	
	animate();
}

function animate() {
	var canvasWidth = canvas.width, canvasHeight = canvas.height;
	context2d.clearRect(0, 0, canvasWidth, canvasHeight);
	
	context2d.strokeStyle = "lightgray";
	context2d.moveTo(0, 0);
	context2d.lineTo(canvasWidth, canvasHeight);
	context2d.moveTo(canvasWidth, 0);
	context2d.lineTo(0, canvasHeight);
	context2d.moveTo(0, canvasHeight/2);
	context2d.lineTo(canvasWidth, canvasHeight/2);
	context2d.moveTo(canvasWidth/2, 0);
	context2d.lineTo(canvasWidth/2, canvasHeight);
	context2d.stroke();
	
	if (beatMan.play) {
		var x = inputMan.x, y = inputMan.y;
		
		if (inputMan.mouse) {
			doFilters(x / canvasWidth, y / canvasHeight);
		}
		
		context2d.fillStyle = "darkgray";
		context2d.beginPath();
		context2d.arc(x, y, 20, 0, Math.PI*2);
		context2d.closePath();
		context2d.stroke();
	}
	
	requestAnimationFrame(animate);
}

// requestAnimationFrame
(function() {
	var lastTime = 0;
	var vendors = ['webkit', 'moz'];
	for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
		window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
		window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
	}
	if (!window.requestAnimationFrame)
		window.requestAnimationFrame = function(callback, element) {
			var currTime = new Date().getTime();
			var timeToCall = Math.max(0, 16 - (currTime - lastTime));
			var id = window.setTimeout(function() { callback(currTime + timeToCall); }, timeToCall);
			lastTime = currTime + timeToCall;
			return id;
		};
	if (!window.cancelAnimationFrame)
		window.cancelAnimationFrame = function(id) {
			clearTimeout(id);
		};
}());

var inputMan = {
	mouse: false,
	x: 0,
	y: 0
};

function mouseXY(event) {
	var x, y;
	
	if (event.touches) {
		x = event.touches[0].pageX;
		y = event.touches[0].pageY;
	}
	else {
		x = event.pageX;
		y = event.pageY;
	}
	
	inputMan.x = x - canvas.offsetLeft;
	inputMan.y = y - canvas.offsetTop;
	
	event.preventDefault();
}

function mouseDown(event) {
	if (!beatMan.play) {
		playMusic();
	}
	
	mouseXY(event);
	inputMan.mouse = true;
}

function mouseMove(event) {
	if (inputMan.mouse) {
		mouseXY(event);
	}
}

function mouseUp(event) {
	inputMan.mouse = false;
}

var audio, audioContext, musicSource, loFilter, hiFilter, bandFilter;
var beatMan = {
	play: false
};

function loadBuffer(source, url, play) {
	var request = new XMLHttpRequest();
	request.open("get", url, true);
	request.responseType = "arraybuffer";
	request.onload = function() {
		source.buffer = audioContext.createBuffer(request.response, false);
		if (play) {
			playMusic();
		}
	}
	request.send();
}

function fileDrop(event) {
	var file = event.dataTransfer.files[0];
	if (file.type.match("audio/*") || file.type.match("video/ogg")) {
		loadMusic(file);
	}
}

function fileInput(files) {
	loadMusic(files[0]);
}

function loadMusic(file) {
	var reader = new FileReader();
	reader.onload = function(event) {
		musicSource.buffer = audioContext.createBuffer(event.target.result, false);
		playMusic();
	}
	reader.readAsArrayBuffer(file);
}

function loadSoundCloud() {
	var text = document.getElementById("text").value;
	if (text) {
		SC.get('/resolve', {url:text}, function(track) {
			if (track.id) {
				var src = "http://api.soundcloud.com/tracks/" + track.id + "/stream?client_id=28c66c838c6f68e374e707978b672fa8";
				audio.src = src;
//				loadBuffer(musicSource, src);
			}
		});
	}
	else {
		playMusic();
	}
}

function playMusic() {
	audio.play();
//	musicSource.noteOn(0);
	beatMan.play = true;
}

function doFilters(x, y) {
	var nyquist = sampleRate / 2;
	var noctaves = Math.log(nyquist / 40) / Math.LN2;
	var res = Math.abs(y - 0.5) * 2;	// map 0.5 to 0

//	if (y < 0.5) {
		var lo = 0.99, hi = 0.01;	// not max to prevent audio deterioration
		
		if (x < 0.5) {	// left half is low pass
			lo = x * 2 * 0.8 + 0.2; // map 0 ~ 0.5 to 0.2 ~ 1
		}
		else if (x > 0.5) {	// right half is high pass
			hi = (x - 0.5) * 2 * 0.8;	// map 0.5 ~ 1 to 0 ~ 0.8
		}
		
		bandFilter.Q.value = bandFilter.Q.minValue;
		
		loFilter.frequency.value = nyquist * Math.pow(2, noctaves * (lo - 1));
		hiFilter.frequency.value = nyquist * Math.pow(2, noctaves * (hi - 1));
		
		loFilter.Q.value = res * 30;	// loFilter.Q.maxValue;
		hiFilter.Q.value = res * 30;	// hiFilter.Q.maxValue;
/*	}
	else {
		loFilter.frequency.value = loFilter.frequency.maxValue;
		hiFilter.frequency.value = hiFilter.frequency.minValue;
		
		bandFilter.frequency.value = nyquist * Math.pow(2, noctaves * (x - 1));
		bandFilter.Q.value = res;
	}*/
}

function loadedMetadata(event) {
console.log("loadedMetadata");
	if (window.webkitAudioContext) {	// web audio api
		if (!audio) {
			audioContext = new webkitAudioContext();
			sampleRate = audioContext.sampleRate;
			
			audio = document.getElementById("music");
			musicSource = audioContext.createMediaElementSource(audio);
//			musicSource = audioContext.createBufferSource();
//			loadBuffer(musicSource, audio.currentSrc);
			musicSource.loop = true;
			
			loFilter = audioContext.createBiquadFilter();
			loFilter.type = 0;	// low pass
			loFilter.frequency.value = loFilter.frequency.maxValue;
			
			hiFilter = audioContext.createBiquadFilter();
			hiFilter.type = 1;	// high pass
			hiFilter.frequency.value = hiFilter.frequency.minValue;
			
			bandFilter = audioContext.createBiquadFilter();
			bandFilter.type = 2;	// band pass
			bandFilter.Q.value = bandFilter.Q.minValue;
			
			musicSource.connect(loFilter);
			loFilter.connect(hiFilter);
			hiFilter.connect(bandFilter);
			bandFilter.connect(audioContext.destination);
		}
		
		if (beatMan.play) {
			audio.play();
		}
	}
}
</script>
<script type="text/javascript">
var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-7050108-2']);_gaq.push(['_trackPageview']);
(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;
ga.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';
var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga,s);})();
</script>
</head>
<body onload="init()" onmouseup="mouseUp(event)" ontouchend="mouseUp(event)">
	<br/>
	<center>
		<audio id="music" onended="this.play()" onloadedmetadata="loadedMetadata(event)">
			<source src="http://api.soundcloud.com/tracks/16166473/stream?client_id=28c66c838c6f68e374e707978b672fa8"/>
			Please use a browser that supports HTML5 Audio
		</audio>
		<canvas id="canvas" width="640" height="320" style="border-style:solid"
			onmousedown="mouseDown(event)" onmousemove="mouseMove(event)"
			ontouchstart="mouseDown(event)" ontouchmove="mouseMove(event)"
			ondragenter="event.stopPropagation(); event.preventDefault();"
			ondragover="event.stopPropagation(); event.preventDefault();"
			ondrop="event.stopPropagation(); event.preventDefault(); fileDrop(event);"
		>Please use a browser that supports HTML5 Canvas</canvas><br/>
		SoundCloud url: <input type="text" id="text" value="http://soundcloud.com/henrikgrunden/avicii-vs-journey-dont-stop" style="width:460px" onkeypress="if(event.keyCode==13){loadSoundCloud()}"/><br/>
	</center>
	<br/>
	<div style="width:480px; margin-left:auto; margin-right:auto">
		<center><b>DJ effects pad</b></center>
		<div>
			Click on pad to start playing track.<br/>
			Click/drag circle to change effects.<br/>
		</div>
		<div style="position:relative; top:5px">
			Low Pass Filter - Drag mouse horizontally in left half of screen.<br/>
			High Pass Filter - Drag mouse horizontally in right half of screen.<br/>
			Resonance - Drag mouse vertically in top or bottom half of screen.<br/>
		</div>
		<div style="position:relative; top:10px">
			Made with Chrome <a href="http://chromium.googlecode.com/svn/trunk/samples/audio/index.html">web audio api</a>, canvas, javascript.
		</div>
	</div>
	<br/>
</body>
</html>
