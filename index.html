<!doctype html>
<!-- DJ effects pad for Sony Music Hackathon 2015 by Shuichi Aizawa -->
<html>
<head>
<title>DJ effects pad</title>
<script type="text/javascript">
"use strict";

var canvas, context2d, audioContext;

var vars = {
	xs:[],
	ys:[],
	sources:[],
	filterOn:[],
	loFilters:[],
	hiFilters:[],
	colors:[
		"rgba(255,0,0,0.5)",
		"rgba(0,255,0,0.5)",
		"rgba(0,0,255,0.5)"
	]
};

window.onload = function() {
	console.log("init");

	function loadAudio(name, file) {
		if (window.AudioContext) {
			var audio = document.createElement("audio");
			audio.onloadedmetadata = loadedMetadata;
			audio.id = name;
			audio.src = file;
		} else {
			var request = new XMLHttpRequest();
			request.open("get", file, true);
			request.responseType = "arraybuffer";
			request.onload = function() {
				console.log("loadedBuffer " + name);

				audioContext = audioContext || new webkitAudioContext();
				var source = audioContext.createBufferSource();
				source.id = name;
				source.buffer = audioContext.createBuffer(request.response, false);
				vars.sources.push(source);
				loadFilters(source);
			}
			request.send();
		}
	}
	loadAudio("Music", "music.wav");
	loadAudio("Vocals", "vocals.wav");
	loadAudio("BG Vocals", "bgvocals.wav");

	canvas = document.getElementById("canvas");
	context2d = canvas.getContext("2d");

	canvas.addEventListener("touchstart", mouseDown);
	canvas.addEventListener("touchmove", mouseMove);
	window.addEventListener("touchend", mouseUp);
	canvas.addEventListener("mousedown", mouseDown);
	canvas.addEventListener("mousemove", mouseMove);
	window.addEventListener("mouseup", mouseUp);
	window.addEventListener("keydown", keyDown);

	draw();
}

function loadedMetadata(event) {
	console.log("loadedMetadata " + event.target.id);

	audioContext = audioContext || new AudioContext();
	var source = audioContext.createMediaElementSource(event.target);
	vars.sources.push(event.target);
	loadFilters(source);
}

function loadFilters(source) {
	var loFilter = audioContext.createBiquadFilter();
	loFilter.type = "lowpass";
	loFilter.frequency.value = audioContext.sampleRate/2;

	var hiFilter = audioContext.createBiquadFilter();
	hiFilter.type = "highpass";
	hiFilter.frequency.value = 10;

	source.connect(loFilter);
	loFilter.connect(hiFilter);
	hiFilter.connect(audioContext.destination);

	vars.loFilters.push(loFilter);
	vars.hiFilters.push(hiFilter);
	vars.filterOn.push(true);

	vars.xs.push(0.5);
	vars.ys.push(0.5);
}

function draw(time) {
	if (!time || vars.play) {
		var canvasWidth = canvas.width, canvasHeight = canvas.height;
		context2d.clearRect(0, 0, canvasWidth, canvasHeight);

		context2d.strokeStyle = "lightgray";
		context2d.moveTo(0, 0);
		context2d.lineTo(canvasWidth, canvasHeight);
		context2d.moveTo(canvasWidth, 0);
		context2d.lineTo(0, canvasHeight);
		context2d.moveTo(0, canvasHeight/2);
		context2d.lineTo(canvasWidth, canvasHeight/2);
		context2d.moveTo(canvasWidth/2, 0);
		context2d.lineTo(canvasWidth/2, canvasHeight);
		context2d.stroke();

		if (vars.play) {
			for (var i = vars.xs.length-1; i >= 0; --i) {
				context2d.strokeStyle = vars.colors[i];
				context2d.beginPath();
				context2d.arc(vars.xs[i] * canvasWidth, vars.ys[i] * canvasHeight, 20, 0, Math.PI*2);
				context2d.stroke();
			}
		}
	}
	requestAnimationFrame(draw);
}

function doFilters(x, y) {
	var nyquist = audioContext.sampleRate / 2;
	var noctaves = Math.log(nyquist / 40) / Math.LN2;
	var res = Math.abs(y - 0.5) * 2;	// map 0.5 to 0

	var lo = 0.99, hi = 0.01;	// not max to prevent audio deterioration

	if (x < 0.5) {	// left half is low pass
		lo = x * 2 * 0.8 + 0.2; // map 0 ~ 0.5 to 0.2 ~ 1
	}
	else if (x > 0.5) {	// right half is high pass
		hi = (x - 0.5) * 2 * 0.8;	// map 0.5 ~ 1 to 0 ~ 0.8
	}

	for (var i = vars.filterOn.length-1; i >= 0; --i) {
		if (vars.filterOn[i]) {
			vars.loFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (lo - 1));
			vars.hiFilters[i].frequency.value = nyquist * Math.pow(2, noctaves * (hi - 1));

			vars.loFilters[i].Q.value = res * 30;
			vars.hiFilters[i].Q.value = res * 30;

			vars.xs[i] = x;
			vars.ys[i] = y;
		}
	}
}

function play() {
	if (!vars.play) {
		for (var i = vars.sources.length-1; i >= 0; --i) {
			if (window.AudioContext) {
				vars.sources[i].play();
			} else {
				vars.sources[i].noteOn(0);
			}
			vars.play = true;
		}
	}
}

function mouseDown(event) {
	mouseXY(event);
	vars.click = true;
}

function mouseXY(event) {
	var x, y;
	if (event.touches) {
		x = event.touches[0].pageX;
		y = event.touches[0].pageY;
	} else {
		x = event.pageX;
		y = event.pageY;
	}
	x -= canvas.offsetLeft;
	y -= canvas.offsetTop;

	doFilters(x / canvas.width, y / canvas.height);
	event.preventDefault();
}

function mouseMove(event) {
	if (vars.click) {
		mouseXY(event);
	}
}

function mouseUp(event) {
	vars.click = false;
}

function keyDown(event) {
	var i = event.keyCode-49;
	if (i >= 0 && i <= vars.filterOn.length-1) {
		vars.filterOn[i] = !vars.filterOn[i];
		console.log(vars.sources[i].id + (vars.filterOn[i] ? " on" : " off"));
	}
}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-7050108-2', 'auto');
ga('send', 'pageview');
</script>
</head>
<body>
	<br/>
	<center>
		<canvas id="canvas" width="640" height="320" style="border-style:solid"></canvas>
		<br/><input type="button" value="  Play  " onclick="play()"/>
	</center>
	<br/>
	<div style="width:480px; margin-left:auto; margin-right:auto">
		<center><b>DJ effects pad</b></center>
		<div>
			Click on pad to start playing track.<br/>
			Click/drag circle to change effects.<br/>
		</div>
		<div style="position:relative; top:5px">
			Low Pass Filter - Drag mouse horizontally in left half of screen.<br/>
			High Pass Filter - Drag mouse horizontally in right half of screen.<br/>
			Resonance - Drag mouse vertically in top or bottom half of screen.<br/>
		</div>
		<div style="position:relative; top:10px">
			Made with Web Audio API.
		</div>
	</div>
	<br/>
</body>
</html>
